<!DOCTYPE html>
<html>
<head>
    <title>PowerCoin Staking DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
</head>
<body>
    <h2>PowerCoin Staking DApp üöÄ</h2>
    
    <button onclick="connectWallet()">Conectar Wallet</button>
    <p><strong>Cuenta:</strong> <span id="walletAddress">No conectada</span></p>

    <h3>Funciones de Staking:</h3>
    <input type="number" id="amount" placeholder="Cantidad de PWR">
    <button onclick="approveAndStake()">Aprobar y Hacer Stake</button>
    <button onclick="unstake()">Unstake</button>
    <button onclick="claimRewards()">Retirar Recompensas</button>

    <h3>Balance:</h3>
    <button onclick="getBalance()">Ver Balance</button>
    <p><strong>Balance PWR:</strong> <span id="balance">0</span></p>

    <script>
        const contractAddress = "0x08eB176EF81Fd35b7927a56Db51E9Cd65299471F"; // Staking contract
        const tokenAddress = "0x36AebF0BB9bD11D67dd69D96858e90FA9057c4d0"; // Token contract (PWR)

        const stakingABI = [
            {
                "constant": false,
                "inputs": [{"name": "amount", "type": "uint256"}],
                "name": "stake",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [],
                "name": "unstake",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [],
                "name": "claimRewards",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{"name": "account", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {"name": "spender", "type": "address"},
                    {"name": "amount", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"name": "", "type": "bool"}],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        let web3;
        let account;
        let contract;
        let tokenContract;

        async function connectWallet() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                await window.ethereum.request({ method: "eth_requestAccounts" });
                const accounts = await web3.eth.getAccounts();
                account = accounts[0];
                document.getElementById("walletAddress").innerText = account;
                contract = new web3.eth.Contract(stakingABI, contractAddress);
                tokenContract = new web3.eth.Contract(stakingABI, tokenAddress);
                console.log("Conectado a:", account);
            } else {
                alert("¬°MetaMask no est√° instalado!");
            }
        }

        async function approveAndStake() {
            const amount = document.getElementById("amount").value;
            if (!amount || amount <= 0) {
                alert("Introduce una cantidad v√°lida.");
                return;
            }

            try {
                // Convertimos a Wei
                const weiAmount = web3.utils.toWei(amount, "ether");

                // Aprobar y verificar confirmaci√≥n
                console.log("‚è≥ Aprobando...");
                const approveTx = await tokenContract.methods.approve(contractAddress, weiAmount)
                    .send({ from: account, gas: 300000, gasPrice: web3.utils.toWei("5", "gwei") });

                console.log("‚úÖ Aprobaci√≥n confirmada:", approveTx.transactionHash);

                // Hacer Stake
                console.log("üî• Haciendo Stake...");
                const stakeTx = await retryTransaction(async () => {
                    return await contract.methods.stake(weiAmount)
                        .send({ from: account, gas: 300000, gasPrice: web3.utils.toWei("5", "gwei") });
                });

                console.log("üéâ Stake exitoso:", stakeTx.transactionHash);
                alert("¬°Stake realizado con √©xito!");
            } catch (error) {
                console.error("‚ùå Error en approve/stake:", error);
                alert("Error en la transacci√≥n. Verifica la consola.");
            }
        }

        async function unstake() {
            try {
                console.log("‚è≥ Ejecutando unstake...");
                const unstakeTx = await retryTransaction(async () => {
                    return await contract.methods.unstake().send({
                        from: account,
                        gas: 300000,
                        gasPrice: web3.utils.toWei("5", "gwei")
                    });
                });

                console.log("üéâ Unstake exitoso:", unstakeTx.transactionHash);
                alert("¬°Unstake realizado con √©xito!");
            } catch (error) {
                console.error("‚ùå Error en unstake:", error);
                alert("Error al hacer unstake.");
            }
        }

        async function claimRewards() {
            try {
                console.log("‚è≥ Reclamando recompensas...");
                const claimTx = await retryTransaction(async () => {
                    return await contract.methods.claimRewards().send({
                        from: account,
                        gas: 200000,
                        gasPrice: web3.utils.toWei("5", "gwei")
                    });
                });

                console.log("üéÅ Recompensas retiradas:", claimTx.transactionHash);
                alert("¬°Recompensas retiradas con √©xito!");
            } catch (error) {
                console.error("‚ùå Error en claimRewards:", error);
                alert("Error al retirar recompensas.");
            }
        }

        async function getBalance() {
            try {
                const balance = await contract.methods.balanceOf(account).call();
                document.getElementById("balance").innerText = web3.utils.fromWei(balance, "ether");
            } catch (error) {
                console.error("‚ùå Error al obtener balance:", error);
                alert("Error al obtener balance.");
            }
        }

        // Funci√≥n para reintentar transacciones si fallan
        async function retryTransaction(txFunction, retries = 3, delay = 3000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const result = await txFunction();
                    return result;
                } catch (error) {
                    console.error(`Intento ${i + 1} fallido:`, error);
                    if (i === retries - 1) throw error;
                    await new Promise((res) => setTimeout(res, delay));
                }
            }
        }
    </script>
</body>
</html>

