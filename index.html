<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerStake - Staking de PLP</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.1/dist/web3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        .title {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 15px;
            text-align: center;
            font-size: 16px;
            width: 100%;
            border-radius: 5px;
            cursor: pointer;
        }
        .button:hover {
            background-color: #45a049;
        }
        .input-field {
            margin: 10px 0;
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">PowerStake - Staking de PLP</div>

        <div>
            <button class="button" id="connectButton">Conectar Billetera</button>
        </div>

        <div id="stakeSection" style="display:none;">
            <input class="input-field" type="number" id="stakeAmount" placeholder="Cantidad de PLP a stakear">
            <select class="input-field" id="stakePeriod">
                <option value="30">30 días</option>
                <option value="60">60 días</option>
                <option value="90">90 días</option>
                <option value="180">180 días</option>
                <option value="360">360 días</option>
            </select>
            <button class="button" id="approveButton">Aprobar PLP</button>
            <button class="button" id="stakeButton" style="display:none;">Stakear</button>
        </div>

        <div id="rewardSection" style="display:none;">
            <div id="userRewards">Recompensas pendientes: 0 PWR</div>
            <button class="button" id="unstakeButton">Retirar</button>
        </div>
    </div>

    <script>
        let web3;
        let account;
        let contract;
        let plpToken;

        const contractAddress = "0xTuDireccionDeContratoAqui";  // Dirección del contrato
        const plpAddress = "0xe5c56E4a8F8d96e3A91b18D83b7f0c36663C9a74";  // Dirección del token PLP
        const pwrAddress = "0x3Eb3B7b3D95Cb3699295D7868F85e43b56AeeFcB";  // Dirección del token PWR
        const abi = [
            // ABI del contrato (truncada para ejemplo, deberías agregar toda la ABI aquí)
            {
                "constant": false,
                "inputs": [
                    { "name": "amount", "type": "uint256" },
                    { "name": "period", "type": "uint256" }
                ],
                "name": "stake",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    { "name": "stakeIndex", "type": "uint256" }
                ],
                "name": "unstake",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    { "name": "user", "type": "address" }
                ],
                "name": "getSPWRBalance",
                "outputs": [
                    { "name": "", "type": "uint256" }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    { "name": "spender", "type": "address" },
                    { "name": "amount", "type": "uint256" }
                ],
                "name": "approve",
                "outputs": [
                    { "name": "", "type": "bool" }
                ],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        window.onload = () => {
            if (typeof window.ethereum !== "undefined") {
                web3 = new Web3(window.ethereum);
                console.log("MetaMask detectado");
            } else {
                alert("Por favor, instala MetaMask para interactuar con el contrato.");
            }

            document.getElementById("connectButton").onclick = connectWallet;
            document.getElementById("approveButton").onclick = approvePLP;
            document.getElementById("stakeButton").onclick = stakePLP;
            document.getElementById("unstakeButton").onclick = unstakePLP;
        };

        async function connectWallet() {
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            account = accounts[0];
            contract = new web3.eth.Contract(abi, contractAddress);
            plpToken = new web3.eth.Contract([
                // ABI del token PLP (aproximado para aprobar)
                {
                    "constant": false,
                    "inputs": [
                        { "name": "spender", "type": "address" },
                        { "name": "amount", "type": "uint256" }
                    ],
                    "name": "approve",
                    "outputs": [
                        { "name": "", "type": "bool" }
                    ],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                }
            ], plpAddress);

            document.getElementById("connectButton").style.display = "none";
            document.getElementById("stakeSection").style.display = "block";
            document.getElementById("rewardSection").style.display = "block";
            updateUserRewards();
        }

        async function updateUserRewards() {
            const rewards = await contract.methods.getSPWRBalance(account).call();
            document.getElementById("userRewards").innerText = `Recompensas pendientes: ${web3.utils.fromWei(rewards, "ether")} PWR`;
        }

        async function approvePLP() {
            const amount = document.getElementById("stakeAmount").value;
            const amountInWei = web3.utils.toWei(amount, "ether");

            try {
                await plpToken.methods.approve(contractAddress, amountInWei).send({ from: account })
                    .on('transactionHash', function(hash) {
                        alert('Aprobación enviada, espera la confirmación.');
                    })
                    .on('receipt', function(receipt) {
                        alert('PLP aprobado exitosamente para staking.');
                        document.getElementById("stakeButton").style.display = "block";  // Habilitar el botón de staking
                    })
                    .on('error', function(error) {
                        alert('Error en la aprobación: ' + error.message);
                    });
            } catch (err) {
                alert("Error al aprobar PLP: " + err.message);
            }
        }

        async function stakePLP() {
            const amount = document.getElementById("stakeAmount").value;
            const period = document.getElementById("stakePeriod").value;
            const amountInWei = web3.utils.toWei(amount, "ether");

            try {
                // Realizar el staking después de la aprobación
                await contract.methods.stake(amountInWei, period).send({ from: account }).on('transactionHash', function(hash) {
                    alert('Transacción de staking enviada.');
                }).on('receipt', function(receipt) {
                    alert('Staking exitoso.');
                    updateUserRewards(); // Actualizar recompensas
                }).on('error', function(error) {
                    alert('Error al hacer staking: ' + error.message);
                });
            } catch (err) {
                alert("Error en staking: " + err.message);
            }
        }

        async function unstakePLP() {
            try {
                const stakeIndex = 0; // Puedes ajustar esto dependiendo del índice del stake

                await contract.methods.unstake(stakeIndex).send({ from: account }).on('transactionHash', function(hash) {
                    alert('Solicitud de retiro enviada.');
                }).on('receipt', function(receipt) {
                    alert('Retiro exitoso.');
                    updateUserRewards();
                }).on('error', function(error) {
                    alert('Error al retirar: ' + error.message);
                });
            } catch (err) {
                alert("Error al retirar: " + err.message);
            }
        }
    </script>
</body>
</html>
